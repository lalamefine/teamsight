{% extends 'base.html.twig' %}

{% block title %}Gestion de campaign{% endblock %}

{% block body %}
    <div class="container pt-3">
        <div class="d-flex justify-content-center mb-3 gap-3">
            {% include 'campaign/fdb360/fdb360form.html.twig' with {'form': form, 'campaign': campaign} %}
            {% if campaign %}
                {% include 'campaign/fdb360/fdb360steps.html.twig' with {'campaign': campaign} %}
            {% endif %}
        </div>
        {% if campaign and campaign.isStateOrAfter('draft') %}
            <div class="bg-white shadow p-4 rounded w-100">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <h3>Observations
                        {% if campaign.isStateOrBefore('ready') %}
                            en préparation
                        {% endif %}
                    </h3>
                    <button type="button" class="btn btn-primary"
                        data-bs-toggle="modal" data-bs-target="#modalContainer"
                        hx-get="{{ path('campaign_manage_select_user', {'campaign': campaign.id}) }}"
                        hx-target="#modalContent" hx-swap="innerHTML" >
                        <i class="bi bi-plus"></i> Ajouter</button>
                </div>
                <input type="text" class="form-control mb-2" placeholder="Rechercher par nom {{campaign.company.config.agtIdType == 'app' ? '' : 'ou identifiant' }}" aria-label="Rechercher" 
                    id="searchInput" onkeyup="filterTable()">
                <div id="campaignContent" hx-get={{ path('app_campaign_manage_fdb360_content', {'campaign': campaign.id}) }} hx-trigger="load"
                    hx-target="#campaignContent" hx-swap="innerHTML">
                    <!-- Campaign content will be loaded here -->
                </div>
            </div>
        {% endif %}
    </div>

    <div>
        {% if campaign.readyToStart %}
            <div class="text-center m-5">
                <a href="{{ path('app_campaign_manage_fdb360_start', {'campaign': campaign.id}) }}" class="btn btn-primary ms-3">
                    <i class="bi bi-rocket-fill"></i> 
                    {% if campaign.beginAt is null %}
                        Démarrer la campaign immédiatement.<br/>
                    {% else %}
                        Valider la constitution des panels et démarrer la campagne le {{ campaign.beginAt|date('d/m/Y') }}.<br/>
                    {% endif %}
                </a>
            </div>
        {% elseif campaign.getCurrentState() == 'ready' %}
            <div class="text-center m-3">
                <i class="bi bi-info-circle-fill"></i>
                La campagne est prête à démarrer à la date prévue.
            </div>
        {% elseif campaign.isStateBefore('ready') %}
            <div class="text-center m-3">
                <i class="bi bi-exclamation-triangle-fill"></i>
                Les panels doivent être conformes pour permettre le lancement de la campagne.
            </div>
        {% endif %}
    </div>

    <div id="modalContainer" class="modal fade modal-xl" 
        tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog" id="modalContent">
            <!-- Modal content will be loaded here via htmx -->
        </div>
    </div>

    <script>
        function filterTable() {
            const input = document.getElementById("searchInput");
            const filter = input.value.toLowerCase();
            const table = document.querySelector("#campaignContent table");
            if (!table) return; // No table found
            const rows = table.getElementsByTagName("tr");

            for (let i = 1; i < rows.length; i++) { // Start from 1 to skip header row
                const cells = rows[i].getElementsByTagName("td");
                let match = false;

                for (let j = 0; j < cells.length; j++) {
                    const cell = cells[j];
                    if (cell) {
                        const textValue = cell.textContent || cell.innerText;
                        if (textValue.toLowerCase().indexOf(filter) > -1) {
                            match = true;
                            break;
                        }
                    }
                }

                rows[i].style.display = match ? "" : "none";
            }
        }
    </script>
{% endblock %}